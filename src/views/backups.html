<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <title>File Backup - RSpace</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; margin: 0; background-color: #f4f7f9; }
        .navbar { background-color: #2c3e50; padding: 15px 30px; color: white; display: flex; justify-content: space-between; align-items: center; }
        .navbar h1 { margin: 0; font-size: 1.5em; }
        .navbar a { color: white; text-decoration: none; margin-left: 20px; }
        .navbar a:hover { text-decoration: underline; }
        .container { max-width: 1000px; margin: 40px auto; padding: 20px; }
        .backup-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 30px; }
        .backup-column { background-color: white; padding: 25px; border-radius: 15px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        h2 { color: #2c3e50; border-bottom: 2px solid #3498db; padding-bottom: 10px; margin-top: 0; }
        .file-list { list-style: none; padding: 0; }
        .file-item { display: flex; justify-content: space-between; align-items: center; padding: 12px; border-bottom: 1px solid #ecf0f1; }
        .file-item:last-child { border-bottom: none; }
        .file-info span { display: block; }
        .file-info .name { font-weight: 500; }
        .file-info .date { font-size: 0.85em; color: #7f8c8d; }
        .download-btn { color: #3498db; text-decoration: none; font-weight: 500; }
        #logout-btn { cursor: pointer; }

        @media (max-width: 768px) {
            .backup-grid { grid-template-columns: 1fr; }
        }
    </style>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
</head>
<body>
    <div class="navbar">
        <h1>ðŸš€ RSpace</h1>
        <div>
            <a href="/dashboard">Dashboard</a>
            <a href="/profile">Profil</a>
            <a href="/users" id="users-link" style="display: none;">Kelola Pengguna</a>
            <a href="/archive">Arsip</a>
            <a href="/backups">Backup</a>
            <a href="#" id="logout-btn">Logout</a>
        </div>
    </div>
    <div class="container">
        <div class="backup-grid">
            <div class="backup-column">
                <h2><i class="fas fa-database"></i> Backup RSpace</h2>
                <ul id="rspace-list" class="file-list"><li>Memuat...</li></ul>
            </div>
            <div class="backup-column">
                <h2><i class="fas fa-folder"></i> Backup PerpusKu</h2>
                <ul id="perpusku-list" class="file-list"><li>Memuat...</li></ul>
            </div>
        </div>
    </div>

    <script>
        const token = localStorage.getItem('rspace_token');
        if (!token) { window.location.href = '/'; }

        const rspaceList = document.getElementById('rspace-list');
        const perpuskuList = document.getElementById('perpusku-list');
        const usersLink = document.getElementById('users-link');

        async function fetchAPI(endpoint) {
            const response = await fetch(endpoint, {
                headers: { 'Authorization': 'Bearer ' + token }
            });
            if (!response.ok) {
                if(response.status === 401 || response.status === 403) {
                     localStorage.removeItem('rspace_token');
                     window.location.href = '/';
                }
                throw new Error(`Gagal memuat data (Status: ${response.status})`);
            }
            return response.json();
        }

        function renderFileList(element, files, type) {
            element.innerHTML = '';
            if (files.length === 0) {
                element.innerHTML = '<li>Tidak ada file backup ditemukan.</li>';
                return;
            }
            files.forEach(file => {
                const li = document.createElement('li');
                li.className = 'file-item';
                li.innerHTML = `
                    <div class="file-info">
                        <span class="name">${file.originalName}</span>
                        <span class="date">Dibuat: ${file.createdAt}</span>
                    </div>
                    <a href="/api/${type}/download/${file.uniqueName}" class="download-btn">Unduh</a>
                `;
                element.appendChild(li);
            });
        }

        async function loadAllBackups() {
            try {
                const rspaceFiles = await fetchAPI('/api/backups/rspace');
                renderFileList(rspaceList, rspaceFiles, 'rspace');
            } catch (error) {
                rspaceList.innerHTML = `<li style="color: red;">${error.message}</li>`;
            }

            try {
                const perpuskuFiles = await fetchAPI('/api/backups/perpusku');
                renderFileList(perpuskuList, perpuskuFiles, 'perpusku');
            } catch (error) {
                perpuskuList.innerHTML = `<li style="color: red;">${error.message}</li>`;
            }
        }
        
        // Cek admin untuk menampilkan link Kelola Pengguna
        fetchAPI('/api/profile').then(data => {
            if (data.id === 1) { usersLink.style.display = 'inline'; }
        });

        // Logout
        document.getElementById('logout-btn').addEventListener('click', () => {
            localStorage.removeItem('rspace_token');
            window.location.href = '/';
        });

        loadAllBackups();
    </script>
</body>
</html>